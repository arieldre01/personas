name: Generate Changelog

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  changelog:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git diff
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Calculate new version
        id: version
        run: |
          # Get current version from CHANGELOG.md
          CURRENT_VERSION=$(grep -oP '## \[\K[0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | head -1 || echo "0.0.0")
          
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="0.0.0"
          fi
          
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Version bump based on PR title
          if [[ "$PR_TITLE" =~ ^(BREAKING|breaking|!) ]]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
          elif [[ "$PR_TITLE" =~ ^(feat|feature|Feat|Feature) ]]; then
            MINOR=$((MINOR + 1)); PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
      
      - name: Generate changelog entry with AI
        id: ai_entry
        continue-on-error: true
        run: |
          # Run your changelog generator (may fail if AI unavailable)
          python generate_changelog.py --ci || true
          
          # Extract the latest entry that was added (if any)
          ENTRY=$(head -20 CHANGELOG.md | grep "^- " | head -1 | sed 's/^- //' || echo "")
          echo "entry=$ENTRY" >> $GITHUB_OUTPUT
        env:
          GITHUB_ACTIONS: true
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      
      - name: Add version and author to changelog
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          python3 << 'SCRIPT'
          import os
          import re
          from datetime import datetime

          version = os.environ.get('NEW_VERSION', '0.0.1')
          author = os.environ.get('PR_AUTHOR', 'unknown')
          pr_number = os.environ.get('PR_NUMBER', '0')
          pr_title = os.environ.get('PR_TITLE', 'Update')
          date = datetime.now().strftime('%Y-%m-%d')

          # Read current changelog
          with open('CHANGELOG.md', 'r') as f:
              content = f.read()

          # Remove any entries under [Unreleased]
          content = re.sub(r'(## \[Unreleased\].*?)(^- .+$\n?)+', r'\1', content, flags=re.MULTILINE)

          # Find where to insert (before first version heading)
          match = re.search(r'^## \[Unreleased\].*$', content, re.MULTILINE)
          if match:
              insert_pos = match.end()
              new_entry = f"\n\n## [{version}] - {date}\n\n- {pr_title} (#{pr_number}) by @{author}\n"
              content = content[:insert_pos] + new_entry + content[insert_pos:]

          # Write updated changelog
          with open('CHANGELOG.md', 'w') as f:
              f.write(content)

          print("Updated CHANGELOG.md:")
          print(content[:1500])
          SCRIPT
      
      - name: Commit and push changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if ! git diff --quiet CHANGELOG.md; then
            git add CHANGELOG.md
            git commit -m "docs: release v${{ steps.version.outputs.new_version }} - changelog for PR #${{ github.event.pull_request.number }}"
            git push
          fi

